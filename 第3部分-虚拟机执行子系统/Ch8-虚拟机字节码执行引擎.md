# 第8章 虚拟机字节码执行引擎
- 代码的编译结果从本地机器码转变为字节码，是存储格式发展的一小步，却是编程语言发展的一大步。

## 8.1 概述
- 执行引擎是Java虚拟机核心的组成部分之一。"虚拟机"是一个相对于"物理机"的概念，这两种机器都由代码执行能力，
其区别是物理机的执行引擎是直接建立在处理器、缓存、指令集和操作系统层面上的，而虚拟机的执行引擎则是由软件自行实现的，
因此可以不受物理条件制约地定制指令集和执行引擎的结构体系，能够执行那些不被硬件直接支持的指令集格式。
- 所有的Java虚拟机的执行引擎输入、输出都是一致的：输入的是字节码二进制流，处理过程是字节码解析执行的等效过程，输出的是执行结果，
本章将主要从概念模型的角度来讲解虚拟机的方法调用和字节码执行。

## 8.2 运行时栈帧结构
- Java虚拟机以方法作为最基本的执行单元，"栈帧"则是用于支持虚拟机进行方法调用和方法执行背后的数据结构，
它也是虚拟机运行时数据区中的虚拟机栈的栈元素。栈帧存储了方法的局部变量表、操作数栈、动态连接和方法返回地址等信息。
每一个方法从调用开始至执行结束的过程，都对应着一个栈帧在虚拟机栈里面从入栈到出栈的过程。
- 每一个栈帧都包含了局部变量表、操作数栈、动态连接、方法返回地址和一些额外附加信息。在编译Java程序源码的时候，
栈帧中需要多大的局部变量表，需要多深的操作数栈就已经被分析计算出来，并且写入到方法表的Code属性之中。换言之，一个栈帧需要分配多少内存，
并不会受到程序运行期变量数据的影响，而仅仅取决于程序源码和具体的虚拟机实现的栈内存布局形式。
- 一个线程中的方法调用链可能会很长，以Java程序的角度来看，同一时刻，同一条线程里面，在调用堆栈的所有方法都同时处于执行状态。
而对于执行引擎来讲，在活动线程中，只有位于栈顶的方法才是在运行的，只有位于栈顶的栈顶才是生效的，其被称为"当前栈帧"，
与这个栈帧所关联的方法被称为"当前方法"。执行引擎所运行的所有字节码指令都只针对当前栈帧进行操作，在概念模型上，典型的栈帧结构如图8-1所示。
![](./pictures/图8-1%20栈帧的概念结构.png)
- 图8-1 栈帧的概念结构


### 8.2.1 局部变量表
- 局部变量表是一组变量值的存储空间，用于存放方法参数和方法内部定义的局部变量。在Java程序被编译为Class文件时，
就在方法的Code属性的max_locals数据项中确定了该方法所需分配的局部变量表的最大容量。